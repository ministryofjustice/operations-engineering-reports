# MoJ Operations Engineering Reports

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Foperations-engineering-reports&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#operations-engineering-reports)

This is a Python / Flask app that uses AWS DynamoDB to store data and display reports. It is used to display the results of the [GitHub Repository Standards](https://github.com/ministryofjustice/github-repository-standards) report.

The intention of this app is to provide a centralised location for all reports that are generated by the Operations Engineering team.

The live site is published [here](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/).

## Table of Contents
1. [Prerequisites](#prerequisites)
1. [Installation](#installation)
1. [Usage](#usage)
1. [Reports](#reports)
1. [Development](#development)
1. [Debugging](#debugging)
1. [Manual Testing](#manual-testing)
1. [AWS Credentials](#aws-credentials)
1. [Troubleshooting](#troubleshooting)
1. [Production](#production)
1. [Deployment](#deployment)


## Prerequisites

To develop, deploy or run this app you will need to install:

- [Python 3.11](https://www.python.org/downloads/release/python-3110/)
- [Flask](https://flask.palletsprojects.com/en/2.2.x/)
- [Docker](https://www.docker.com/)
- [AWS CLI](https://aws.amazon.com/cli/)
- [AWS DynamoDB Local](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html)
- [Helm](https://helm.sh/)
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)

## Installation

To install the app, run the following commands:

```bash
# Clone the repository
git clone

# Change directory into the repository
cd operations-engineering-reports

# Create a virtual environment
python3 -m venv venv

# Activate the virtual environment
source venv/bin/activate

# Install the dependencies
pip install -r requirements.txt
```

## Usage

To run the app, run the following commands:

```bash
# Change directory into the repository
cd operations-engineering-reports

# Activate the virtual environment
source venv/bin/activate

# Run the app
flask --app report_app run --debug
```

## Reports

Currently, the app supports a single report, the [GitHub Repository Standards](https://github.com/ministryofjustice/github-repository-standards). Our intention is to expand this offering to show more content in the future.

## Development

There are multiple ways to run the Flask App with or without an AWS DynamoDB local instance running in a Docker container.

Without a database you can use you can execute:

```bash
# Install flask i.e. brew install flask
flask --app report_app run --debug
```

Once running the App can be opened in a browser `http://127.0.0.1:4567` for the development server or `http://127.0.0.1` when running the production server locally.

To be able to use the login feature and see the private repository report requires creating a `.env` file at the root of the repository, obtaining two AUTH0 values from the AUTH0 [site](https://auth0.com/) and creating an encryption key using `dynambodb_testing/helper_code.py/example_encrypt_decrypt`.

The .env layout:

```
AUTH0_CLIENT_ID=
AUTH0_CLIENT_SECRET=
AUTH0_DOMAIN=operations-engineering.eu.auth0.com
APP_SECRET_KEY=appSecret123
ENCRYPTION_KEY=
```

Edit `~/.aws/config` and add `cli_pager=` to negate the need to press a button to continue the terminal when AWS commands are completed within the termial.

Run `make local` to run a local instance of the Flask App and a local AWS DynamoDB instance. This runs the App in the terminal and the AWS DynamoDB instance in a Docker container. This will run `scripts/start-local.sh`. When running the App using this command, you may need to press Q twice to continue the terminal when the AWS commands to create and add data to the database are executed. Use `crtl + c` to cancel the App and it will automatically remove the Docker container.

Run `make dev` to run a local instance of the Flask App and a local AWS DynamoDB instance. This runs the App and database in seperate containers using Docker compose.

Run `make prod` to run a local instance of the production Flask App and a local AWS DynamoDB instance. This runs the App and database in seperate containers using Docker compose. The gunicorn production server is used in this mode. Lint will be run against the python code before the Docker container is created.

Run `make stop` to stop both Docker commands above.

## Manual Testing

See the files in the `dynambodb_testing` folder for the commands and code that can be used to create, setup, add data to the table, etc to the AWS DynamoDB local instance running within a Docker container.

## AWS Credentials

AWS env variables are set and used when creating, writing and reading from the AWS DynamoDB local instance. The env variables should be the same for each operation on the database wether via an AWS command or within code else they will fail. You will find the env variables are set in the VS Code debugger start files `launch.json` and `tasks.json`, in the `scripts/start-local.sh` script file and the Docker compose files `docker-compose.yml` and `docker-compose-prod.yml`. This generally involves setting and using the same env values `AWS_ACCESS_KEY_ID = DUMMYIDEXAMPLE`, `AWS_SECRET_ACCESS_KEY = DUMMYEXAMPLEKEY` and `AWS_DEFAULT_REGION = eu-west-2` when creating, writing and reading the database. For production the AWS keys are over written using the following env variables values `DYNAMODB_ACCESS_KEY_ID`, `DYNAMODB_SECRET_ACCESS_KEY`, and `DYNAMODB_REGION`.

## Troubleshooting

With the database use the AWS scan command to see if the database exists and has data. If it does not exist use the commands or code to create the database and add the data. The credentials used in the App and the database must match as explained in AWS Credentials section.

## Deployment

#### Development

The development namespace for this project is called `operations-engineering-reports-dev`.

To deploy the app to the development namespace, simply push to the `main` branch. The deployment will trigger a `helm upgrade` command to update the deployment.

If you wish to deploy manually, follow the steps outlined in the [deploy-to-dev](https://github.com/ministryofjustice/operations-engineering-reports/blob/main/.github/workflows/deploy-to-dev.yml) GitHub Action.

You can see the development app running at: https://operations-engineering-reports-dev.cloud-platform.service.justice.gov.uk/

and access Cloud Platform's namespace using:

```bash
kubectl get pods -n operations-engineering-reports-dev
```

or using the Helm commands:

```bash
helm list -n operations-engineering-reports-dev
helm history -n operations-engineering-reports-dev operations-engineering-reports-dev
```

#### Production

The production namespace on [Cloud Platform](https://user-guide.cloud-platform.service.justice.gov.uk/documentation/concepts/what-is-the-cloud-platform.html) for this project is called `operations-engineering-reports-prod`.

You can see the production app running at: https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/

To deploy the app to the production namespace do the following:

- push to the `main` branch.
- create a new tag using `git tag vn.n.n` where `n.n.n` is the version number. Please follow [semantic versioning](https://semver.org/).
- push the tag to the remote repository using `git push origin --tags`

This will trigger a GitHub Action that will create a release and deploy the app to the production namespace.
